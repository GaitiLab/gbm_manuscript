---
title: "Notebook to reproduce Figure 3a"
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
author: "Yiyan Wu"
params:
    input: "data/multiome_results/10_ArchR_new/CellClass_L5_2"
    out_dir: "output"
output: html_document
---


```{r, rmarkdown-setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here(), warning = FALSE)
```

## Prepare data
```{r, prep-data}
pacman::p_load(ArchR, presto, ggplot2, ggrepel, mitch, fgsea, readr, msigdbr, escape, dittoSeq, tidyr, dplyr, stringr, data.table,GaitiLabUtils, GBMutils, glue, data.table, tidyverse, stringr)

# Load the marker list
marker_dir <- paste0(params$input, "/DA/NPC2+/CellClass_L5_2_archr_top10000_PT_TE", "/Pairwise_DA_", "all", "_low_vs_high.csv")
marker_list <- fread(marker_dir)

# Specify the log2FC and FDR cutoffs
curr.log2FC <- 0.38
curr.fdr <- 0.05

# Align significant and insignificant genes
marker_list <- marker_list %>%
    mutate(diffaccessible = case_when(
        log2FC > curr.log2FC & FDR <= curr.fdr ~ "Accessible in Invasive-high OPC/NPC1",
        log2FC < -curr.log2FC & FDR <= curr.fdr ~ "Accessible in Progenitor-like (NPC + OPC)",
        TRUE ~ "Not significant"
    ))

# change the order of the factor
marker_list$diffaccessible <- factor(marker_list$diffaccessible, levels = c("Accessible in Invasive-high OPC/NPC1", "Not significant", "Accessible in Progenitor-like (NPC + OPC)"))

# Generate label for plot annotation
marker_list$dalabel <- NA
marker_list$dalabel[marker_list$diffaccessible != "Not significant"] <- marker_list$name[marker_list$diffaccessible != "Not significant"]

# Overlay the volcano plot with the NOTCH signaling pathway genes
all_gene_sets = msigdbr(species = "Homo sapiens")
specific_gene <- all_gene_sets %>%
    filter(gs_name == "WP_NOTCH_SIGNALING") %>%
    pull(gene_symbol)
marker_list <- marker_list %>%
    mutate(highlight = case_when(
        name %in% specific_gene & diffaccessible == "Accessible in Invasive-high OPC/NPC1" ~ "yes",
        TRUE ~ "no"
    ))

# Color palette
color_palette <- c("yes" = "#d61f26", "no" = "black", "specific_gene" = "#00798CFF")

```

## Visualize
```{r, vis, fig.width = 5, fig.height = 6}
volc <- ggplot(data = marker_list, aes(x = log2FC, y = -log10(FDR), label = name)) +
    geom_point(aes(color = highlight), size = 1, alpha = 0.25, stroke = NA) +
    geom_point(data = marker_list[marker_list$highlight != "no", ], aes(color = highlight), size = 1.5) +
    geom_vline(xintercept = curr.log2FC, linetype = "dashed", alpha = 0.5) +
    geom_vline(xintercept = -curr.log2FC, linetype = "dashed", alpha = 0.5) +
    geom_hline(yintercept = -log10(curr.fdr), linetype = "dashed", alpha = 0.5) +
    expand_limits(x = c(-ceiling(max(abs(marker_list$log2FC))), ceiling(max(abs(marker_list$log2FC))))) +
    geom_label_repel(
        data = marker_list[marker_list$highlight != "no", ],
        fill = "white",
        label.padding = 0.1,
        box.padding = 0.5,
        size = 3,
        min.segment.length = 0,
        aes(color = highlight),
        show.legend = FALSE,
        max.overlaps = Inf,
        force = 2,
        nudge_x = 0.3,
        nudge_y = 0.3
    ) +
    scale_color_manual(values = color_palette, guide = guide_legend(title = "")) +
    guides(color = guide_legend(title = "")) +
    labs(
        x = expression(Log[2] * " Fold Change (Gene accessibility score)"),
        y = expression(-Log[10] * " FDR")
    ) +
    theme_minimal() +
    theme(
        legend.key = element_blank(),
        legend.position = "bottom",
        plot.title.position = "plot",
        axis.line = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
    )
ggsave(
    filename = paste0("DiffAccess_", "all", "_low_vs_high_highlight_NOTCH.pdf"),
    path = params$out_dir,
    units = "in", width = 5, height = 5
)

volc
```

## Session Info
```{r, session-info, echo = FALSE}
sessionInfo()
```
